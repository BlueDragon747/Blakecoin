FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

# Build essentials + all dependencies for native daemon + Qt wallet builds
# Ubuntu 20.04: GCC 9, Boost 1.71, Qt 5.12, OpenSSL 1.1.1
RUN apt-get update && apt-get install -y \
    build-essential g++ make autoconf automake libtool libtool-bin pkg-config \
    git wget curl \
    libssl-dev \
    libboost-all-dev \
    libminiupnpc-dev \
    libevent-dev \
    libprotobuf-dev protobuf-compiler \
    qtbase5-dev qttools5-dev qttools5-dev-tools \
    libqrencode-dev \
    && rm -rf /var/lib/apt/lists/*

# Build BerkeleyDB 4.8 from source (Bitcoin PPA unavailable for 20.04+)
RUN wget -q "https://download.oracle.com/berkeley-db/db-4.8.30.NC.tar.gz" && \
    tar xzf db-4.8.30.NC.tar.gz && \
    cd db-4.8.30.NC/build_unix && \
    sed -i 's/__atomic_compare_exchange/__atomic_compare_exchange_db/' ../dbinc/atomic.h && \
    ../dist/configure --enable-cxx --disable-shared --with-pic --prefix=/usr/local && \
    make -j$(nproc) && make install && \
    cd / && rm -rf db-4.8.30.NC*

# Create build directory
RUN mkdir -p /build

WORKDIR /build

# Verify toolchain
RUN g++ --version && \
    echo "native-base 20.04 ready â€” GCC 9, Boost 1.71, Qt 5.12, BDB 4.8"
